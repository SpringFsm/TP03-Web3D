<!DOCTYPE html>
<html>
<head>
    <title>Exercice WebXR - Joueur avec A-Frame</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="player-controller.js"></script>
</head>
<script>
  AFRAME.registerComponent('player-controller', {
    schema: {
        speed: { type: 'number', default: 0.1 },
        acceleration: { type: 'number', default: 0.005 },
        deceleration: { type: 'number', default: 0.01 },
        jumpForce: { type: 'number', default: 0.3 }
    },

    init: function () {
        this.velocity = new THREE.Vector3();
        this.keys = {};
        this.isGrounded = true;
        this.gravity = -0.01;

        // Écouteurs d'événements pour les touches du clavier
        document.addEventListener('keydown', (e) => this.onKeyDown(e));
        document.addEventListener('keyup', (e) => this.onKeyUp(e));
    },

    onKeyDown: function (e) {
        this.keys[e.key.toLowerCase()] = true;
    },

    onKeyUp: function (e) {
        this.keys[e.key.toLowerCase()] = false;
    },

    tick: function (time, deltaTime) {
        const el = this.el;
        const data = this.data;

        // Mise à jour de la vitesse en fonction des touches pressées
        const moveVector = new THREE.Vector3(0, 0, 0);

        if (this.keys['z']) moveVector.z -= 1;
        if (this.keys['s']) moveVector.z += 1;
        if (this.keys['q']) moveVector.x -= 1;
        if (this.keys['d']) moveVector.x += 1;

        if (moveVector.length() > 0) {
            moveVector.normalize();
            this.velocity.x += moveVector.x * data.acceleration * (deltaTime / 100);
            this.velocity.z += moveVector.z * data.acceleration * (deltaTime / 100);
        }

        // Accélération et Décélération
        this.velocity.x *= (1 - data.deceleration);
        this.velocity.z *= (1 - data.deceleration);

        // Saut
        if (this.isGrounded && this.keys[' ']) {
            this.velocity.y = data.jumpForce;
            this.isGrounded = false;
        }

        // Gravité
        this.velocity.y += this.gravity;

        // Mise à jour de la position
        el.object3D.position.x += this.velocity.x;
        el.object3D.position.y += this.velocity.y;
        el.object3D.position.z += this.velocity.z;

        // Vérification de la hauteur pour ground check
        if (el.object3D.position.y <= 0.5) {
            el.object3D.position.y = 0.5;
            this.velocity.y = 0;
            this.isGrounded = true;
        }
    }
});
</script>
<body>
    <a-scene>
        <a-entity light="type: ambient; color: #BBB; intensity: 0.5"></a-entity>
        <a-entity light="type: directional; color: #FFF; intensity: 0.5; position: -1 1 2"></a-entity>

        <a-assets>
            <img id="grass-texture" src="public/Poliigon_GrassPatchyGround_4585_BaseColor.jpg">
            <img id="sky-texture" src="public/Cold Sunset Equirect.png">
        </a-assets>

        <a-plane
            src="#grass-texture"
            repeat="10 10"
            width="10"
            height="10"
            rotation="-90 0 0"
            position="0 0 0">
        </a-plane>

        <a-sky src="#sky-texture"></a-sky>

        <a-box
            position="0 0 0"
            color="#FF5733"
            player-controller>
            
            <a-entity
                camera
                look-controls
                wasd-controls="enabled: false"
                position="0 1.6 5">
            </a-entity>
        </a-box>
    </a-scene>
</body>
</html>