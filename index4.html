<!DOCTYPE html>
<html>
<head>
  <title>Exercice 4</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
</head>
<script>
  // Joueur avec inertie et contrôles ZQSD relatifs à la caméra
  AFRAME.registerComponent('player-controller', {
    schema: { 
      speed: { type: 'number', default: 0.1 }, 
      jumpForce: { type: 'number', default: 0.3 },
      accel: { type: 'number', default: 0.01 },   // accélération progressive
      friction: { type: 'number', default: 2 }   // décélération progressive
    },
    init: function () {
      this.velocity = new THREE.Vector3();   // vitesse actuelle
      this.targetVel = new THREE.Vector3();  // vitesse désirée
      this.keys = {};
      this.isGrounded = true;
      this.gravity = -0.01;

      document.addEventListener('keydown', e => this.keys[e.key.toLowerCase()] = true);
      document.addEventListener('keyup', e => this.keys[e.key.toLowerCase()] = false);
    },
    tick: function () {
      const el = this.el;
      const move = new THREE.Vector3();

      // Inputs en ZQSD
      if (this.keys['z']) move.z -= 1;
      if (this.keys['s']) move.z += 1;
      if (this.keys['q']) move.x += 1;
      if (this.keys['d']) move.x -= 1;

      if (move.length() > 0) move.normalize();

      // Orientation caméra
      const cameraRig = document.querySelector('#camera-rig').object3D;
      const dir = new THREE.Vector3();
      cameraRig.getWorldDirection(dir);

      // Forward et Right horizontaux
      const forward = new THREE.Vector3(dir.x, 0, dir.z).normalize();
      const right = new THREE.Vector3().crossVectors(forward, new THREE.Vector3(0, 1, 0)).normalize();

      // Direction finale
      const moveDir = new THREE.Vector3();
      moveDir.addScaledVector(forward, move.z);
      moveDir.addScaledVector(right, move.x);
      if (moveDir.length() > 0) moveDir.normalize();

      // Vitesse désirée
      this.targetVel.set(moveDir.x * this.data.speed, this.velocity.y, moveDir.z * this.data.speed);

      // Interpolation progressive (accélération/décélération)
      this.velocity.x += (this.targetVel.x - this.velocity.x) * this.data.accel * 60;
      this.velocity.z += (this.targetVel.z - this.velocity.z) * this.data.accel * 60;

      // Saut
      if (this.isGrounded && this.keys[' ']) {
        this.velocity.y = this.data.jumpForce;
        this.isGrounded = false;
      }

      // Gravité
      if (!this.isGrounded) {
        this.velocity.y += this.gravity;
      }

      // Appliquer la vitesse
      el.object3D.position.add(this.velocity);

      // Détection du sol
      if (el.object3D.position.y <= 0.5) {
        el.object3D.position.y = 0.5;
        this.velocity.y = 0;
        this.isGrounded = true;
      }
    }
  });

  // Rotation du rig caméra
  AFRAME.registerComponent('rig-rotate', {
    schema: { sensitivity: { type: 'number', default: 0.005 } },
    init: function () {
      this.isDragging = false;
      this.rotationY = 0;
      this.rotationX = 0;
      const pivot = this.el.querySelector('#camera-pivot');

      window.addEventListener('mousedown', e => { if (e.button === 0) this.isDragging = true; });
      window.addEventListener('mouseup', e => { if (e.button === 0) this.isDragging = false; });
      window.addEventListener('mousemove', e => {
        if (!this.isDragging || !pivot) return;

        this.rotationY -= e.movementX * this.data.sensitivity;
        this.el.object3D.rotation.y = this.rotationY;

        this.rotationX -= e.movementY * this.data.sensitivity;
        const max = 0;
        const min = -Math.PI / 2 * 0.5;
        this.rotationX = Math.max(min, Math.min(max, this.rotationX));
        pivot.object3D.rotation.x = this.rotationX;
      });
    }
  });
</script>
<body>
<a-scene>
  <!-- Lumières -->
  <a-entity light="type: ambient; color: #BBB; intensity: 0.5"></a-entity>
  <a-entity light="type: directional; color: #FFF; intensity: 0.5; position: -1 1 2"></a-entity>

  <!-- Assets -->
  <a-assets>
    <img id="grass-texture" src="public/floor.jpg">
    <img id="sky-texture" src="public/sky.png">
  </a-assets>

  <!-- Sol -->
  <a-plane src="#grass-texture" width="20" height="20" rotation="-90 0 0" repeat="10 10"></a-plane>

  <!-- Skybox -->
  <a-sky src="#sky-texture"></a-sky>

  <!-- Cube joueur -->
  <a-box id="player" position="0 0.5 0" color="#FF5733" player-controller></a-box>

  <!-- Camera rig -->
  <a-entity id="camera-rig" rig-rotate follow="target: #player; offset: 0 1.5 0">
    <a-entity id="camera-pivot" rotation="0 0 0">
      <a-entity camera position="0 0 5"></a-entity>
    </a-entity>
  </a-entity>
</a-scene>

<!-- Rig suit le joueur -->
<script>
  AFRAME.registerComponent('follow', {
    schema: { target: { type: 'selector' }, offset: { type: 'vec3', default: {x:0,y:1.5,z:0} } },
    tick: function () {
      if (!this.data.target) return;
      const t = this.data.target.object3D.position;
      this.el.object3D.position.set(
        t.x + this.data.offset.x,
        t.y + this.data.offset.y,
        t.z + this.data.offset.z
      );
    }
  });
</script>
</body>
</html>
